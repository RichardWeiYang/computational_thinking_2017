# 虚拟机

## 本章节逻辑模型

* 背景
    * 虚拟机在计算机软件架构中是非必要的一层，却为整个计算机软件架构的工业发展带来了重要的影响
    * 虚拟机体现了透过中间过渡层实现在上下隔离的同时上下兼容
* 目标
    * 让学生了解虚拟机是甚么
    * 让学生了解虚拟机在计算机软件架构中的作
    * 让学生了解虚拟机所体现的计算思维
* 输入
    * （见参考材料）
* 过程
    * 讲解虚拟机发展历史
    * 讲解虚拟机的核心功能
        * 如何兼容汇编语言
        * 如何兼容高级语言
    * 讲解虚拟机在计算机软件架构中的作用
    * 讲解虚拟机所体现的计算思维
* 输出
    * -
* 效果
    * -

## 虚拟机概念出现前

* 高级语言的实现依赖于存储硬件的实现
    * 计算机硬件的不同（如存储空间大小，存储硬件结构等）会导致高级语言编写的程序不能从一个平台迁移到另一个平台

* 每台计算机在一段时间内只能执行一组程序
    * 计算机的使用效率低

## 虚拟机发展史

* 20世纪60年代
    * 1964年，IBM推出System/360
        * 通过虚拟机监视器(Virtual Machine Monitor)虚拟所有的硬件接口
    * 1965年，IBM公司的"M44/44X"计算机项目
        * 定义了虚拟内存管理机制
        * 分割的虚拟内存为多个用户的程序提供了独立的计算环境
    * 1968年，IBM小组研发剑桥监视系统（Cambridge Monitoring System，CMS）
        * 分时系统的一个实验

* 20世纪70年代
    * 1970年，IBM推出VM/370
        * 基于CMS开发多用户环境的操作系统
        * 许多企业和大学都使用这个操作系统, 因为它允许他们共享主机的计算能力和资源
        * 每个用户在他们自己的虚拟机中工作，从而可以和其他人共享资源而不影响其他人的工作
    * 1974年，贝尔实验室的Denise Richie和Ken Thompson (UNIX的发明者) 提出用虚拟机的概念来让运行进程
        * 让每个进程面对一个虚拟机器
        * 程序移植性提高

* 其后，虚拟机的概念被拓展, 如VMware实现了在一种操作系统上运行另一种操作系统等

## 虚拟机的功能

* 虚拟硬件接口
    * 透过在虚拟机中提供逻辑接口
    * 上层软件默认可以透过逻辑接口控制硬制，或透过虚拟机反馈得知硬件不存在/未接入

* 虚拟存储空间
    * 定义了虚拟存储空间到物理存储空间的映射
    * 上层软件只看到连续的虚拟存储空间，即使它是由多个独立的物理存储空间组成的
        * 这是因为数字本身可以拆开，只需要按照一定顺序拼接即可还原
    * 基于虚拟存储空间，一台计算机分割为多个虚拟机
        * 为每台虚拟机分配独立的存储空间
            * 每台虚拟机只看到各自的虚拟存储空间而不会影响其他虚拟机的存储空间
            * 这种思想后被演变成操作系统中的进程
        * 计算机的每一瞬间只有台虚拟机在运行
            * 即计算机具体在运行该虚拟机上的程序
            * 透过时间片切换模拟多台虚拟机同时运行 (分时系统)
        * 让某台虚拟机能看到所有虚拟机并控制虚拟机之间的切换
            * 即操作系统
            * 利用软件来运行和管理子软件

## 虚拟机的作用

* 本质上是标准化的计算机逻辑框架
    * 保证内部功能可被实现: 这套框架为高级语言提供标准化的调用硬件资源的接口和规则
        * 高级语言的开发只需要符合虚拟机提供的逻辑接口，即可在不同的硬件上运行 (可迁移)
    * 保证外部协调不受影响: 在这套框架也定义了程序之间如何在逻辑上共享一组计算机的物理资源（计算资源和存储资源）
        * 编程的时候不需要考虑计算机其他程序的运行可能带来的影响

* 实现方法: 对底层封装, 实现软硬件架构的隔离但保持同构
    * 对于现有的主流硬件架构，讧制一套弹性的硬件架构的虚拟接口
        * [例] 家庭电脑不一定连接著打印机，但只连上打印机，虚拟接口与物理接口对应即可打印东西
    * 对于现有的主流存储硬件，订制虚拟存储空间和物理存储空间之间的对应关系
        * [例] 硬盘中的磁盘是按圈保存内容的，经常映射即可看成连续的物理存储空间
    * 随著硬件更迭，汇编语言优化，需要订制从虚拟机指令到汇编语言的翻译器 (VM Translator)

* 价值高的核心原因
    * 新程序的开发要远比硬件更迭快
    * 为了硬件的一次更新而把现有的程序都进行调整的成本很高
    * 虚拟机的出现使得每次硬件更新只需要调整虚拟机的实现即可继续支持大部分现有的程序

## 示意图

* 软硬件架构图

```
高级语言程序----------------->汇编语言程序------->机器语言程序----->计算机硬件实现
     |                             ^
     |                             |
     |                             |
     ----------->虚拟机-------------
```

* 虚拟机与物理架构

```
   ------------------------------------------       --------------------------------------
   |                                        |       |                                    |
   |    虚拟CPU      虚拟CPU     虚拟CPU    |       |    CPU                             |
   |       |            |            |      |       |     |                              |
   |       |            |            |      |       |     |-----------------------       |
   |       |            |            |      | ====> |     |            |         |       |
   |       v            v            v      |       |     v            v         v       |
   |  ----------   ----------   ----------  |       | ---------------------------------- |
   | | 虚拟存储 | | 虚拟存储 | | 虚拟存储 | |       | | 物理存储 | 物理存储 | 物理存储 | |
   |  ----------   ----------   ----------  |       | |   1/3    |    1/3   |   1/3    | |
   |                                        |       | ---------------------------------- |
   |                                        |       |                                    |
   ------------------------------------------       --------------------------------------
```

## 虚拟机背后的计算思维

* 抽象化

* 透过在不同时间段使用同一组资源实现使用权的共享，提高资源利用率
    * [例] 一个住屋单位里有一个洗手间和多个房间，每个房间由不同人住，洗手间轮流使用

* 基于封装使得使用更简单
    * [例] 软件工具
    * [例] 封装好的开源工具库
    * [例] 计算思维

## 参考材料

* 汇编语言出现的历史背景 [link](http://blog.csdn.net/shisiye15/article/details/7697399)
* 编程语言发展史上有哪些趣事？ - 知乎 [link](https://www.zhihu.com/question/19811764)
* 即使高手也未必知晓 虚拟机的历史 - cnBeta [link](http://www.cnbeta.com/articles/127802.htm)